# Makefile –¥–ª—è TB Group API

.PHONY: help install migrate-neon dev build test clean

# –ù–∞—Å—Ç—Ä–æ–π–∫–∏
DB_NAME ?= tb_group
NEON_URL ?= "postgresql://postgres:password@ep-xxx.neon.tech/tb_group?sslmode=require"

help: ## –ü–æ–∫–∞–∑–∞—Ç—å —Å–ø—Ä–∞–≤–∫—É
	@echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-20s\033[0m %s\n", $$1, $$2}'

install: ## –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
	pnpm install

migrate-neon: ## –ú–∏–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ Neon (—Ç—Ä–µ–±—É–µ—Ç NEON_URL)
	@if [ -z "$(NEON_URL)" ] || [ "$(NEON_URL)" = "postgresql://postgres:password@ep-xxx.neon.tech/tb_group?sslmode=require" ]; then \
		echo "‚ùå Error: Please set NEON_URL"; \
		echo "Usage: make migrate-neon NEON_URL='postgresql://...'; \
		exit 1; \
	fi
	@echo "üöÄ Starting migration to Neon..."
	export DATABASE_URL=$(NEON_URL) && \
	npx prisma generate && \
	npx prisma migrate deploy && \
	echo "‚úÖ Migration completed!"

db-push: ## –û–±–Ω–æ–≤–∏—Ç—å —Å—Ö–µ–º—É –ë–î (–¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏)
	npx prisma db push

db-reset: ## –°–±—Ä–æ—Å–∏—Ç—å –ë–î (–û–°–¢–û–†–û–ñ–ù–û! –£–¥–∞–ª–∏—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ)
	npx prisma migrate reset --force

db-seed: ## –ó–∞–ø–æ–ª–Ω–∏—Ç—å –ë–î —Ç–µ—Å—Ç–æ–≤—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
	npx prisma db seed

db-studio: ## –û—Ç–∫—Ä—ã—Ç—å Prisma Studio
	npx prisma studio

dev: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏
	NODE_ENV=development npm run dev

build: ## –°–æ–±—Ä–∞—Ç—å –ø—Ä–æ–µ–∫—Ç
	npm run build

test: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç—ã
	npm run test

test-unit: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å unit —Ç–µ—Å—Ç—ã
	npm run test:unit

test-integration: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å integration —Ç–µ—Å—Ç—ã
	npm run test:integration

test-e2e: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å e2e —Ç–µ—Å—Ç—ã
	npm run test:e2e

test-all: ## –ó–∞–ø—É—Å—Ç–∏—Ç—å –≤—Å–µ —Ç–µ—Å—Ç—ã
	npm run test:all

lint: ## –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–¥ –ª–∏–Ω—Ç–µ—Ä–æ–º
	npm run lint

lint-fix: ## –ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫–∏ –ª–∏–Ω—Ç–µ—Ä–∞
	npm run lint:fix

clean: ## –û—á–∏—Å—Ç–∏—Ç—å —Å–±–æ—Ä–∫—É
	npm run clean

openapi: ## –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å OpenAPI –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é
	npx tsx src/openapi/generate.ts

bootstrap-admin: ## –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤–æ–≥–æ –∞–¥–º–∏–Ω–∞
	npx tsx src/scripts/bootstrap-admin.ts

# –°–æ—Å—Ç–∞–≤–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
setup-dev: install db-push db-seed ## –ü–æ–ª–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–ª—è —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏

test-ci: lint test-all ## –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–ª—è CI

deploy: migrate-neon build ## –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –∫ –¥–µ–ø–ª–æ—é

help-migrate: ## –ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Neon
	@echo "–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –ø–æ –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω–∞ Neon:"
	@echo "1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç –Ω–∞ https://neon.tech"
	@echo "2. –ü–æ–ª—É—á–∏—Ç–µ connection string"
	@echo "3. –í—ã–ø–æ–ª–Ω–∏—Ç–µ: make migrate-neon NEON_URL='–≤–∞—à_connection_string'"
	@echo ""
	@echo "–ü–æ–ª–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏: https://github.com/your-repo/NEON_MIGRATION_GUIDE.md"
